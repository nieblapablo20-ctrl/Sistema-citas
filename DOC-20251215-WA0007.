<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reservas Psicoterapia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ff9800, #ffeb3b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .badge {
            display: inline-block;
            background: #ff4081;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2 i {
            font-size: 1.5rem;
        }
        
        .filtros-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        .filtro-tipo {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filtro-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .filtro-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .filtro-btn:hover:not(.active) {
            background: #dee2e6;
            transform: translateY(-2px);
        }
        
        .filtro-input {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .filtro-input.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #horarios-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .horario-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .horario-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .horario-item.high-demand {
            border-left: 5px solid #ff4081;
            background: linear-gradient(to right, #fff5f7, white);
        }
        
        .horario-item.medium-demand {
            border-left: 5px solid #ffa726;
            background: linear-gradient(to right, #fff3e0, white);
        }
        
        .horario-item.sabado-demand {
            border-left: 5px solid #4CAF50;
            background: linear-gradient(to right, #e8f5e8, white);
        }
        
        .horario-item.high-demand::before {
            content: 'üî•';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }
        
        .horario-info {
            flex: 1;
        }
        
        .fecha {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .hora {
            color: #666;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .hora.premium {
            color: #ff4081;
            font-weight: bold;
        }
        
        .demanda-tag {
            display: inline-block;
            background: #ff4081;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .sabado-tag {
            display: inline-block;
            background: #4CAF50;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
            vertical-align: middle;
            font-weight: bold;
        }
        
        .reservar-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .reservar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .reservar-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 1rem;
        }
        
        input[type="text"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input[type="text"]:focus,
        input[type="tel"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input[readonly] {
            background: #f0f0f0;
            color: #666;
        }
        
        select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2366' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .submit-btn {
            background: linear-gradient(45deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-message {
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            display: block;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            color: white;
            padding: 30px;
            opacity: 0.8;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            margin-top: 40px;
        }
        
        .availability-info {
            background: linear-gradient(45deg, #fff8e1, #ffecb3);
            border: 2px solid #ffd54f;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
            color: #5d4037;
        }
        
        .availability-info i {
            color: #ff9800;
            margin-right: 10px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Filtros d√≠as */
        .dias-semana {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .dia-btn {
            padding: 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .dia-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .dia-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .dia-btn .dia-nombre {
            font-weight: bold;
            font-size: 1rem;
        }
        
        .dia-btn .dia-fecha {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .fecha-grupo {
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .fecha-grupo-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fecha-grupo-contenido {
            padding: 15px;
        }
        
        .contador-horarios {
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        /* Estilos para el campo de tel√©fono */
        .telefono-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Informaci√≥n de la reserva */
        .reserva-info {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .reserva-info.adulto {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }
        
        .reserva-info.adolescente {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }
        
        .reserva-info.pareja {
            background: #f3e5f5;
            border-left-color: #9C27B0;
        }
        
        .reserva-info.familia {
            background: #fff3e0;
            border-left-color: #FF9800;
        }
        
        .reserva-info-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .reserva-info-list {
            margin: 0;
            padding-left: 20px;
            color: #333;
            font-size: 1rem;
        }
        
        .reserva-info-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .precio-destacado {
            color: #ff9800;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Secci√≥n de tipos de terapia */
        .terapia-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .terapia-section h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .terapia-select-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .terapia-select-container i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calendar-check"></i> Sistema de Reservas Psicoterapia</h1>
            <p class="subtitle">Reserva tu sesi√≥n de Terapia Psicol√≥gica</p>
            <div class="badge">
                <i class="fas fa-bolt"></i> Horario de citas disponibles
            </div>
        </header>
        
        <div class="content">
            <!-- Columna izquierda: Horarios disponibles -->
            <div class="card">
                <h2><i class="fas fa-clock"></i> Horarios Disponibles</h2>
                
                <div class="availability-info">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="demanda-text">Mostrando horarios</span>
                </div>
                
                <div class="filtros-container">
                    <div class="filtro-tipo">
                        <button class="filtro-btn active" data-tipo="semana-actual">
                            <i class="fas fa-calendar-week"></i> Esta semana
                        </button>
                        <button class="filtro-btn" data-tipo="semana-siguiente">
                            <i class="fas fa-calendar-alt"></i> Pr√≥xima semana
                        </button>
                        <button class="filtro-btn" data-tipo="hora-especifica">
                            <i class="fas fa-search"></i> Buscar por hora
                        </button>
                    </div>
                    
                    <div class="filtro-input active" id="filtro-semana-actual">
                        <p style="margin-bottom: 15px; color: #666;">Selecciona un d√≠a de esta semana:</p>
                        <div id="dias-semana-actual" class="dias-semana"></div>
                    </div>
                    
                    <div class="filtro-input" id="filtro-semana-siguiente">
                        <p style="margin-bottom: 15px; color: #666;">Selecciona un d√≠a de la pr√≥xima semana:</p>
                        <div id="dias-semana-siguiente" class="dias-semana"></div>
                    </div>
                    
                    <div class="filtro-input" id="filtro-hora-especifica">
                        <label for="buscar-hora">
                            <i class="fas fa-filter"></i> Filtra por hora espec√≠fica:
                        </label>
                        <select id="buscar-hora" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #dee2e6;">
                            <option value="">Selecciona una hora</option>
                        </select>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-info-circle"></i> Solo muestra horarios con disponibilidad esta semana
                        </p>
                    </div>
                </div>
                
                <div id="horarios-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando horarios exclusivos...</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Solo mostramos los horarios m√°s solicitados</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <p style="color: #666; margin-bottom: 10px;">
                        <i class="fas fa-chart-line"></i> Mostrando 
                        <span id="contador-horarios" style="font-weight: bold; color: #667eea;">0</span> 
                        horarios disponibles
                    </p>
                    <button id="refresh-btn" class="submit-btn" style="background: linear-gradient(45deg, #2196F3, #1976D2); margin-top: 10px;">
                        <i class="fas fa-sync-alt"></i> Actualizar Disponibilidad
                    </button>
                </div>
            </div>
            
            <!-- Columna derecha: Formulario de reserva -->
            <div class="card">
                <h2><i class="fas fa-edit"></i> Reservar Horario</h2>
                
                <form id="reserva-form">
                    <div class="form-group">
                        <label for="nombre">
                            <i class="fas fa-user"></i> Nombre completo:
                        </label>
                        <input type="text" id="nombre" name="nombre" 
                               placeholder="Ingresa tu nombre y apellido" 
                               required
                               minlength="5">
                        <div class="telefono-info">
                            <i class="fas fa-info-circle"></i> Ejemplo: Juan P√©rez Gonz√°lez
                        </div>
                    </div>
                    
                    <!-- CAMPO DE TEL√âFONO INTEGRADO -->
                    <div class="form-group">
                        <label for="telefono">
                            <i class="fas fa-phone"></i> Tel√©fono:
                        </label>
                        <input type="tel" id="telefono" name="telefono" 
                               placeholder="Ingresa tu n√∫mero de 10 d√≠gitos" 
                               required
                               pattern="[0-9]{10}"
                               maxlength="10"
                               inputmode="numeric">
                        <div class="telefono-info">
                            <i class="fas fa-info-circle"></i> Ejemplo: 6691234567 (10 d√≠gitos sin espacios)
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha-seleccionada">
                            <i class="fas fa-calendar"></i> Fecha seleccionada:
                        </label>
                        <input type="text" id="fecha-seleccionada" readonly 
                               placeholder="Selecciona un horario de la lista">
                    </div>
                    
                    <div class="form-group">
                        <label for="hora-seleccionada">
                            <i class="fas fa-clock"></i> Hora seleccionada:
                        </label>
                        <input type="text" id="hora-seleccionada" readonly 
                               placeholder="Selecciona un horario de la lista">
                    </div>
                    
                    <!-- LIST DE TIPOS DE TERAPIA (SELECT/DROPDOWN) -->
                    <div class="terapia-section">
                        <h3><i class="fas fa-heart"></i> Selecciona el tipo de terapia:</h3>
                        <div class="terapia-select-container">
                            <select id="tipo-terapia-select" name="tipo-terapia" class="select-terapia">
                                <option value="adulto">Terapia Individual (Adulto) - $500 MXN</option>
                                <option value="adolescente">Terapia Adolescente - $400 MXN</option>
                                <option value="pareja">Terapia de Pareja - $700 MXN</option>
                                <option value="familia">Terapia Familiar - $800 MXN</option>
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        
                        <!-- INFORMACI√ìN DE LA RESERVA QUE CAMBIA SEG√öN EL SELECT -->
                        <div id="info-reserva" class="reserva-info adulto">
                            <div class="reserva-info-title">
                                <i class="fas fa-info-circle"></i> Detalles de tu reserva:
                            </div>
                            <ul class="reserva-info-list" id="lista-info">
                                <!-- La informaci√≥n se actualiza din√°micamente seg√∫n el select -->
                                <li>Duraci√≥n: <strong>1 hora</strong></li>
                                <li>Precio: <span class="precio-destacado">$500 MXN</span></li>
                                <li>Para: <strong>Mayores de 18 a√±os</strong></li>
                                <li>Tipo: <strong>Terapia Individual (Adulto)</strong></li>
                            </ul>
                        </div>
                    </div>
                    
                    <input type="hidden" id="tipo-terapia" name="tipo-terapia" value="adulto">
                    <input type="hidden" id="fecha" name="fecha">
                    <input type="hidden" id="hora" name="hora">
                    
                    <button type="submit" class="submit-btn" id="submit-btn" disabled>
                        <i class="fas fa-check-circle"></i> Confirmar Reserva
                    </button>
                    
                    <p style="margin-top: 15px; text-align: center; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-lock"></i> Tu reserva se confirmar√° inmediatamente
                    </p>
                </form>
                
                <div id="status-message" class="status-message"></div>
            </div>
        </div>
        
        <footer>
            <p><i class="fas fa-copyright"></i> 2025 Sistema de Reservas Pablo Niebla. Todos los derechos reservados.</p>
            <p style="font-size: 0.9rem; margin-top: 15px;">
                <i class="fas fa-sync"></i> √öltima actualizaci√≥n: 
                <span id="last-update" style="font-weight: bold;">--:--:--</span>
            </p>
        </footer>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        // ¬°IMPORTANTE! Cambia esta URL por la correcta de tu Web App
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyf0OmT9Dc1dFt_b1KioCjwHq2ENP2dFAI3DHIx83cx/dev';
        
        // Variables globales
        let horariosDisponibles = [];
        let horariosFiltrados = [];
        let horarioSeleccionado = null;
        let filtroActivo = 'semana-actual';
        let horaFiltro = '';
        let fechaFiltro = '';
        let tipoTerapiaSeleccionada = 'adulto';
        
        // Configuraci√≥n de tipos de terapia
        const tiposTerapia = {
            adulto: {
                nombre: 'Terapia Individual (Adulto)',
                precio: 500,
                duracion: '1 hora',
                edad: 'Mayores de 18 a√±os',
                descripcion: 'Terapia individual para adultos',
                colorClase: 'adulto',
                icono: 'fas fa-user'
            },
            adolescente: {
                nombre: 'Terapia Adolescente',
                precio: 400,
                duracion: '1 hora',
                edad: 'De 13 a 17 a√±os',
                descripcion: 'Terapia para adolescentes',
                colorClase: 'adolescente',
                icono: 'fas fa-user-graduate'
            },
            pareja: {
                nombre: 'Terapia de Pareja',
                precio: 700,
                duracion: '1:15 a 1:30 hrs',
                edad: 'Parejas',
                descripcion: 'Terapia de pareja',
                colorClase: 'pareja',
                icono: 'fas fa-heart'
            },
            familia: {
                nombre: 'Terapia Familiar',
                precio: 800,
                duracion: '1:30 hrs',
                edad: 'Toda la familia',
                descripcion: 'Terapia familiar',
                colorClase: 'familia',
                icono: 'fas fa-home'
            }
        };
        
        // Elementos DOM
        const elementos = {
            horariosList: document.getElementById('horarios-list'),
            fechaSeleccionada: document.getElementById('fecha-seleccionada'),
            horaSeleccionada: document.getElementById('hora-seleccionada'),
            fechaInput: document.getElementById('fecha'),
            horaInput: document.getElementById('hora'),
            submitBtn: document.getElementById('submit-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            statusMessage: document.getElementById('status-message'),
            lastUpdate: document.getElementById('last-update'),
            reservaForm: document.getElementById('reserva-form'),
            contadorHorarios: document.getElementById('contador-horarios'),
            filtroBtns: document.querySelectorAll('.filtro-btn'),
            filtroInputs: document.querySelectorAll('.filtro-input'),
            buscarHora: document.getElementById('buscar-hora'),
            demandaText: document.getElementById('demanda-text'),
            telefonoInput: document.getElementById('telefono'),
            tipoTerapiaInput: document.getElementById('tipo-terapia'),
            tipoTerapiaSelect: document.getElementById('tipo-terapia-select'),
            infoReserva: document.getElementById('info-reserva'),
            listaInfo: document.getElementById('lista-info')
        };
        
        // Nombres en espa√±ol
        const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // ==================== FUNCIONES UTILITARIAS ====================
        
        function formatearFechaParaMostrar(fechaStr) {
            const [year, month, day] = fechaStr.split('-');
            const fecha = new Date(year, month - 1, day);
            const diaSemana = diasSemana[fecha.getDay()];
            return `${diaSemana} ${parseInt(day)} de ${meses[parseInt(month) - 1]}`;
        }
        
        function obtenerFechaCorta(fechaStr) {
            const [year, month, day] = fechaStr.split('-');
            const fecha = new Date(year, month - 1, day);
            const diaNombre = diasSemana[fecha.getDay()].substring(0, 3);
            const mesNombre = meses[parseInt(month) - 1].substring(0, 3);
            return `${diaNombre} ${parseInt(day)} ${mesNombre}`;
        }
        
        function obtenerDiaSemana(fechaStr) {
            const [year, month, day] = fechaStr.split('-');
            const fecha = new Date(year, month - 1, day);
            return diasSemana[fecha.getDay()];
        }
        
        function extraerHorasUnicasEstaSemana(horarios) {
            const diasEstaSemana = generarDiasSemana(0).map(d => d.fecha);
            const horasSet = new Set();
            
            horarios.forEach(horario => {
                if (diasEstaSemana.includes(horario.fecha)) {
                    horasSet.add(horario.hora);
                }
            });
            
            return Array.from(horasSet).sort();
        }
        
        function llenarSelectorHoras(horas) {
            elementos.buscarHora.innerHTML = '<option value="">Selecciona una hora</option>';
            horas.forEach(hora => {
                const horaNum = parseInt(hora.split(':')[0]);
                const esTarde = horaNum >= 16 && horaNum <= 18;
                
                const option = document.createElement('option');
                option.value = hora;
                option.textContent = hora + (esTarde ? ' üî•' : '');
                elementos.buscarHora.appendChild(option);
            });
        }
        
        // ==================== FUNCI√ìN MEJORADA PARA GENERAR D√çAS ====================
        
        function generarDiasSemana(semanaOffset = 0) {
            const hoy = new Date();
            const dias = [];
            
            // Empezar desde el lunes de la semana indicada
            const fechaInicio = new Date(hoy);
            
            // Ir al lunes de esta semana
            const diaSemanaHoy = fechaInicio.getDay();
            const diferenciaLunes = diaSemanaHoy === 0 ? 1 : 1 - diaSemanaHoy;
            
            const lunesSemana = new Date(fechaInicio);
            lunesSemana.setDate(fechaInicio.getDate() + diferenciaLunes + (semanaOffset * 7));
            
            // Generar 6 d√≠as (Lunes a S√°bado)
            for (let i = 0; i < 6; i++) {
                const fecha = new Date(lunesSemana);
                fecha.setDate(lunesSemana.getDate() + i);
                
                // Ya no saltamos domingos porque empezamos en lunes
                const fechaStr = fecha.toISOString().split('T')[0];
                const diaNombre = diasSemana[fecha.getDay()];
                const diaNumero = fecha.getDate();
                const mesNombre = meses[fecha.getMonth()].substring(0, 3);
                
                dias.push({
                    fecha: fechaStr,
                    nombre: diaNombre,
                    display: `${diaNombre} ${diaNumero} ${mesNombre}`,
                    short: `${diaNombre.substring(0, 3)} ${diaNumero}`,
                    diaNumero: diaNumero,
                    mesNombre: mesNombre
                });
            }
            
            return dias;
        }
        
        // ==================== FUNCIONES DE TIPOS DE TERAPIA ====================
        
        function configurarTiposTerapia() {
            // Configurar evento para el select
            elementos.tipoTerapiaSelect.addEventListener('change', function() {
                tipoTerapiaSeleccionada = this.value;
                elementos.tipoTerapiaInput.value = tipoTerapiaSeleccionada;
                actualizarInfoReserva(tipoTerapiaSeleccionada);
            });
            
            // Inicializar con la terapia por defecto
            actualizarInfoReserva(tipoTerapiaSeleccionada);
        }
        
        function actualizarInfoReserva(tipo) {
            const terapia = tiposTerapia[tipo];
            
            // Actualizar la lista de informaci√≥n
            elementos.listaInfo.innerHTML = `
                <li>Duraci√≥n: <strong>${terapia.duracion}</strong></li>
                <li>Precio: <span class="precio-destacado">$${terapia.precio} MXN</span></li>
                <li>Para: <strong>${terapia.edad}</strong></li>
                <li>Tipo: <strong>${terapia.nombre}</strong></li>
            `;
            
            // Actualizar el color del contenedor
            elementos.infoReserva.className = `reserva-info ${terapia.colorClase}`;
            
            console.log(`‚úÖ Terapia seleccionada: ${terapia.nombre} - $${terapia.precio}`);
        }
        
        // ==================== FUNCIONES DE SELECCI√ìN ====================
        
        function seleccionarHorarioPorId(horarioId) {
            try {
                console.log('üéØ Seleccionando horario por ID:', horarioId);
                
                // Buscar el horario por ID (fecha_hora)
                const [fecha, hora] = horarioId.split('_');
                const horaFormateada = hora.slice(0,2) + ':' + hora.slice(2);
                
                // Buscar en todos los horarios disponibles
                const horarioEncontrado = horariosDisponibles.find(h => 
                    h.fecha === fecha && h.hora === horaFormateada
                );
                
                if (!horarioEncontrado) {
                    console.error('‚ùå Horario no encontrado ID:', horarioId);
                    mostrarError('Este horario ya no est√° disponible. Por favor, selecciona otro.', 'error');
                    return;
                }
                
                console.log('‚úÖ Horario encontrado:', horarioEncontrado);
                
                // Validar s√°bados
                const horaNum = parseInt(horarioEncontrado.hora.split(':')[0]);
                const fechaObj = new Date(horarioEncontrado.fecha + 'T' + horarioEncontrado.hora);
                const esSabado = fechaObj.getDay() === 6;
                
                if (esSabado && (horaNum < 9 || horaNum > 14)) {
                    mostrarError('‚ùå Los s√°bados solo hay horarios de 9:00 a 14:00');
                    return;
                }
                
                // Asignar valores
                horarioSeleccionado = horarioEncontrado;
                
                elementos.fechaSeleccionada.value = formatearFechaParaMostrar(horarioEncontrado.fecha);
                elementos.horaSeleccionada.value = horarioEncontrado.hora;
                elementos.fechaInput.value = horarioEncontrado.fecha;
                elementos.horaInput.value = horarioEncontrado.hora;
                
                elementos.submitBtn.disabled = false;
                mostrarMensaje('‚úÖ Horario seleccionado. Completa tus datos para confirmar la reserva.', 'success');
                
                // Scroll suave al formulario
                elementos.reservaForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error('‚ùå Error en seleccionarHorarioPorId:', error);
                mostrarError('Error al seleccionar horario. Por favor, intenta nuevamente.');
            }
        }
        
        // ==================== FUNCIONES DE FILTROS ====================
        
        function mostrarDiasFiltro() {
            console.log('üìÖ Configurando filtros por d√≠a...');
            
            // Semana actual
            const diasActual = generarDiasSemana(0);
            const contenedorActual = document.getElementById('dias-semana-actual');
            
            // Semana siguiente
            const diasSiguiente = generarDiasSemana(1);
            const contenedorSiguiente = document.getElementById('dias-semana-siguiente');
            
            // Configurar semana actual
            if (contenedorActual) {
                contenedorActual.innerHTML = '';
                diasActual.forEach(dia => {
                    const btn = crearBotonDia(dia);
                    contenedorActual.appendChild(btn);
                });
            }
            
            // Configurar semana siguiente
            if (contenedorSiguiente) {
                contenedorSiguiente.innerHTML = '';
                diasSiguiente.forEach(dia => {
                    const btn = crearBotonDia(dia);
                    contenedorSiguiente.appendChild(btn);
                });
            }
            
            // DEBUG: Mostrar fechas generadas
            console.log('üìÖ Semana actual:', diasActual.map(d => `${d.fecha} (${d.nombre})`));
            console.log('üìÖ Semana siguiente:', diasSiguiente.map(d => `${d.fecha} (${d.nombre})`));
        }
        
        function crearBotonDia(dia) {
            const btn = document.createElement('button');
            btn.className = 'dia-btn';
            btn.dataset.fecha = dia.fecha;
            btn.innerHTML = `
                <div class="dia-nombre">${dia.nombre.substring(0, 3)}</div>
                <div class="dia-fecha">${dia.diaNumero}</div>
            `;
            btn.onclick = () => filtrarPorDia(dia.fecha);
            return btn;
        }
        
        function filtrarPorDia(fecha) {
            console.log('üóìÔ∏è Filtrando por d√≠a:', fecha);
            fechaFiltro = fecha;
            filtroActivo = 'dia-especifico';
            
            // Activar bot√≥n del d√≠a
            document.querySelectorAll('.dia-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.fecha === fecha) {
                    btn.classList.add('active');
                }
            });
            
            aplicarFiltros();
        }
        
        function cambiarFiltro(tipo) {
            console.log('üîß Cambiando filtro a:', tipo);
            
            // Actualizar botones activos
            elementos.filtroBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tipo === tipo) {
                    btn.classList.add('active');
                }
            });
            
            // Actualizar contenido visible
            elementos.filtroInputs.forEach(input => {
                input.classList.remove('active');
                if (input.id === `filtro-${tipo}`) {
                    input.classList.add('active');
                }
            });
            
            // Actualizar filtro activo
            filtroActivo = tipo;
            
            // Limpiar filtros espec√≠ficos
            if (tipo !== 'hora-especifica') {
                elementos.buscarHora.value = '';
                horaFiltro = '';
            }
            if (tipo !== 'dia-especifico') {
                fechaFiltro = '';
                document.querySelectorAll('.dia-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            // Aplicar filtros
            aplicarFiltros();
        }
        
        function aplicarFiltros() {
            console.log('üîç Aplicando filtros:', { filtroActivo, fechaFiltro, horaFiltro });
            
            if (horariosDisponibles.length === 0) {
                console.log('‚ö†Ô∏è No hay horarios para filtrar');
                return;
            }
            
            let resultado = [...horariosDisponibles];
            
            // Aplicar filtro seg√∫n tipo
            switch(filtroActivo) {
                case 'semana-actual':
                    const diasSemanaActual = generarDiasSemana(0).map(d => d.fecha);
                    console.log('üìÖ D√≠as semana actual:', diasSemanaActual);
                    resultado = resultado.filter(h => diasSemanaActual.includes(h.fecha));
                    break;
                    
                case 'semana-siguiente':
                    const diasSemanaSiguiente = generarDiasSemana(1).map(d => d.fecha);
                    console.log('üìÖ D√≠as semana siguiente:', diasSemanaSiguiente);
                    resultado = resultado.filter(h => diasSemanaSiguiente.includes(h.fecha));
                    break;
                    
                case 'dia-especifico':
                    if (fechaFiltro) {
                        resultado = resultado.filter(h => h.fecha === fechaFiltro);
                    }
                    break;
                    
                case 'hora-especifica':
                    if (horaFiltro) {
                        const diasEstaSemana = generarDiasSemana(0).map(d => d.fecha);
                        resultado = resultado.filter(h => 
                            diasEstaSemana.includes(h.fecha) && h.hora === horaFiltro
                        );
                    }
                    break;
            }
            
            horariosFiltrados = resultado;
            
            // Actualizar contador
            elementos.contadorHorarios.textContent = resultado.length;
            
            // Actualizar mensaje de demanda
            actualizarMensajeDemanda(resultado.length);
            
            // Mostrar horarios filtrados
            mostrarHorariosFiltrados(resultado);
        }
        
        function actualizarMensajeDemanda(cantidad) {
            let mensaje = '';
            
            if (cantidad === 0) {
                mensaje = '‚ö†Ô∏è Sin disponibilidad en este momento';
            } else if (cantidad <= 3) {
                mensaje = 'üî• √öltimos horarios disponibles';
            } else if (cantidad <= 6) {
                mensaje = '‚ö° Horarios disponibles - Reserva pronto';
            } else {
                mensaje = 'üìÖ Mostrando horarios - Disponibilidad limitada';
            }
            
            elementos.demandaText.textContent = mensaje;
        }
        
        function mostrarHorariosFiltrados(horarios) {
            if (horarios.length === 0) {
                let mensaje = 'No hay horarios disponibles en este momento.';
                let subMensaje = 'Intenta con otros filtros o vuelve m√°s tarde.';
                
                if (filtroActivo === 'semana-actual') {
                    mensaje = 'Horarios agotados para esta semana.';
                    subMensaje = 'Consulta la pr√≥xima semana o prueba otros horarios.';
                } else if (filtroActivo === 'semana-siguiente') {
                    mensaje = 'Sin disponibilidad la pr√≥xima semana.';
                    subMensaje = 'Los horarios se abren semanalmente.';
                } else if (filtroActivo === 'hora-especifica' && horaFiltro) {
                    const horaNum = parseInt(horaFiltro.split(':')[0]);
                    const esTarde = horaNum >= 16 && horaNum <= 18;
                    mensaje = esTarde 
                        ? `üî• ${horaFiltro} - Horario agotado`
                        : `No hay disponibilidad a las ${horaFiltro}`;
                    subMensaje = 'Prueba con otro horario o consulta m√°s tarde.';
                } else if (filtroActivo === 'dia-especifico' && fechaFiltro) {
                    const fechaFormateada = obtenerFechaCorta(fechaFiltro);
                    mensaje = `Sin disponibilidad para el ${fechaFormateada}.`;
                    subMensaje = 'Este d√≠a est√° completo. Prueba con otra fecha.';
                }
                
                elementos.horariosList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">üìÖ</div>
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">${mensaje}</p>
                        <p style="font-size: 0.9rem; color: #888;">${subMensaje}</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar por fecha
            const horariosPorFecha = {};
            horarios.forEach(horario => {
                if (!horariosPorFecha[horario.fecha]) {
                    horariosPorFecha[horario.fecha] = [];
                }
                horariosPorFecha[horario.fecha].push(horario);
            });
            
            // Ordenar fechas
            const fechasOrdenadas = Object.keys(horariosPorFecha).sort();
            
            let html = '';
            
            // Mostrar todas las fechas disponibles
            fechasOrdenadas.forEach((fecha, fechaIndex) => {
                const fechaCorta = obtenerFechaCorta(fecha);
                const diaNombre = obtenerDiaSemana(fecha);
                const horariosFecha = horariosPorFecha[fecha];
                
                // Contar horarios de alta demanda (4-6pm)
                const horariosAltaDemanda = horariosFecha.filter(h => {
                    const hora = parseInt(h.hora.split(':')[0]);
                    return hora >= 16 && hora <= 18;
                }).length;
                
                // Contar horarios de s√°bado
                const esSabado = diaNombre === 'S√°bado';
                const horariosSabado = esSabado ? horariosFecha.length : 0;
                
                html += `
                    <div class="fecha-grupo" style="margin-bottom: ${fechaIndex === fechasOrdenadas.length - 1 ? '0' : '25px'};">
                        <div class="fecha-grupo-header">
                            <span>${fechaCorta}</span>
                            <span class="contador-horarios">
                                ${horariosFecha.length} horario${horariosFecha.length > 1 ? 's' : ''}
                                ${horariosAltaDemanda > 0 ? ` | ${horariosAltaDemanda} üî•` : ''}
                                ${esSabado ? ` | ${horariosSabado} üèÅ` : ''}
                            </span>
                        </div>
                        <div class="fecha-grupo-contenido">
                `;
                
                // Ordenar horarios: tarde primero, s√°bados especial
                horariosFecha.sort((a, b) => {
                    const horaA = parseInt(a.hora.split(':')[0]);
                    const horaB = parseInt(b.hora.split(':')[0]);
                    
                    // S√°bados: 9am-2pm tienen m√°xima prioridad
                    if (esSabado) {
                        return horaA - horaB; // S√°bados orden ascendente
                    }
                    
                    // Lunes a Viernes: tarde primero
                    const prioridadA = (horaA >= 16 && horaA <= 18) ? 3 : 
                                      (horaA >= 14 && horaA <= 19) ? 2 : 1;
                    const prioridadB = (horaB >= 16 && horaB <= 18) ? 3 : 
                                      (horaB >= 14 && horaB <= 19) ? 2 : 1;
                    
                    if (prioridadB !== prioridadA) {
                        return prioridadB - prioridadA;
                    }
                    return horaA - horaB;
                });
                
                // Mostrar todos los horarios disponibles
                horariosFecha.forEach((horario, index) => {
                    const horaNum = parseInt(horario.hora.split(':')[0]);
                    const esAltaDemanda = horaNum >= 16 && horaNum <= 18;
                    const esTarde = horaNum >= 14 && horaNum <= 19;
                    const esSabadoHorario = diaNombre === 'S√°bado';
                    
                    // Determinar clase CSS
                    let claseExtra = '';
                    if (esAltaDemanda) claseExtra = 'high-demand';
                    else if (esTarde) claseExtra = 'medium-demand';
                    else if (esSabadoHorario) claseExtra = 'sabado-demand';
                    
                    // Crear ID √∫nico para el bot√≥n
                    const horarioId = horario.fecha + '_' + horario.hora.replace(':', '');
                    
                    // Tags especiales
                    let tagEspecial = '';
                    if (esAltaDemanda) tagEspecial = '<span class="demanda-tag">üî• MAS SOLICITADO</span>';
                    else if (esSabadoHorario) tagEspecial = '<span class="sabado-tag">üèÅ S√ÅBADO</span>';
                    
                    html += `
                        <div class="horario-item ${claseExtra}" 
                             style="margin-bottom: ${index === horariosFecha.length - 1 ? '0' : '12px'};">
                            <div class="horario-info">
                                <div class="hora ${esTarde || esSabadoHorario ? 'premium' : ''}">
                                    <i class="fas fa-clock"></i> ${horario.hora}
                                    ${tagEspecial}
                                </div>
                            </div>
                            <button class="reservar-btn" onclick="seleccionarHorarioPorId('${horarioId}')">
                                <i class="fas fa-bookmark"></i> Reservar
                            </button>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            elementos.horariosList.innerHTML = html;
        }
        
        // ==================== FUNCI√ìN DE RESERVA MEJORADA ====================
        
        async function enviarReserva(event) {
            event.preventDefault();
            
            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const tipoTerapia = tipoTerapiaSeleccionada;
            const terapiaInfo = tiposTerapia[tipoTerapia];
            
            if (!nombre || !telefono || !horarioSeleccionado) {
                mostrarError('‚ùå Por favor, completa todos los campos');
                return;
            }
            
            // Validar nombre
            const nombrePartes = nombre.split(' ').filter(p => p.length > 0);
            if (nombrePartes.length < 2) {
                mostrarError('‚ùå Por favor ingresa tu nombre completo (al menos nombre y apellido)');
                return;
            }
            
            // Validar tel√©fono (10 d√≠gitos)
            if (!/^[0-9]{10}$/.test(telefono)) {
                mostrarError('‚ùå El tel√©fono debe tener exactamente 10 d√≠gitos');
                return;
            }
            
            elementos.submitBtn.disabled = true;
            elementos.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando reserva...';
            
            try {
                console.log('üì§ Enviando reserva con todos los datos:', { 
                    nombre: nombre, 
                    telefono: telefono,
                    tipoTerapia: tipoTerapia,
                    edad: terapiaInfo.edad,
                    precio: terapiaInfo.precio,
                    duracion: terapiaInfo.duracion,
                    fecha: horarioSeleccionado.fecha, 
                    hora: horarioSeleccionado.hora 
                });
                
                return new Promise((resolve, reject) => {
                    const callbackName = 'reservaCallback_' + Date.now();
                    
                    window[callbackName] = function(data) {
                        console.log('‚úÖ Respuesta de reserva recibida:', data);
                        
                        delete window[callbackName];
                        
                        elementos.submitBtn.disabled = false;
                        elementos.submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Reserva';
                        
                        if (data && data.success) {
                            const fechaFormateada = formatearFechaParaMostrar(horarioSeleccionado.fecha);
                            const mensajeExito = `‚úÖ Reserva confirmada para ${nombre} (${terapiaInfo.nombre}) el ${fechaFormateada} a las ${horarioSeleccionado.hora}`;
                            
                            mostrarMensaje(mensajeExito, 'success');
                            
                            // WhatsApp con formato profesional
                            const mensajeWhatsApp = `‚úÖ *RESERVA CONFIRMADA* ‚úÖ%0A%0A` +
                                                  `üë§ *Paciente:* ${nombre}%0A` +
                                                  `üìû *Tel√©fono:* ${telefono}%0A` +
                                                  `üíº *Tipo de Terapia:* ${terapiaInfo.nombre}%0A` +
                                                  `üí∞ *Precio:* $${terapiaInfo.precio} MXN%0A` +
                                                  `‚è±Ô∏è *Duraci√≥n:* ${terapiaInfo.duracion}%0A` +
                                                  `üë• *Edad:* ${terapiaInfo.edad}%0A` +
                                                  `üìÖ *Fecha:* ${fechaFormateada}%0A` +
                                                  `üïê *Hora:* ${horarioSeleccionado.hora}%0A` +
                                                  `üìù *Estado:* Confirmado%0A` +
                                                  `üìç *Origen:* Reserva Web%0A` +
                                                  `‚è∞ *Marca temporal:* ${new Date().toLocaleString('es-MX')}%0A%0A` +
                                                  `üìã *Detalles de la reserva:*%0A` +
                                                  `‚Ä¢ Sistema: Reservas Online Premium%0A` +
                                                  `‚Ä¢ C√≥digo: RSV-${Date.now().toString().slice(-6)}%0A` +
                                                  `‚Ä¢ Descripci√≥n: ${terapiaInfo.descripcion}`;
                            
                            setTimeout(() => {
                                window.open(`https://wa.me/526694462216?text=${mensajeWhatsApp}`, "_blank");
                            }, 1000);
                            
                            // Limpiar formulario
                            elementos.reservaForm.reset();
                            elementos.fechaSeleccionada.value = '';
                            elementos.horaSeleccionada.value = '';
                            horarioSeleccionado = null;
                            elementos.submitBtn.disabled = true;
                            
                            // Recargar horarios despu√©s de 2 segundos
                            setTimeout(() => {
                                cargarHorarios();
                                mostrarMensaje('üîÑ Horarios actualizados despu√©s de tu reserva.', 'success');
                            }, 2000);
                            
                            resolve(data);
                        } else {
                            const errorMsg = data?.error || data?.message || 'Error desconocido al procesar la reserva';
                            mostrarError(`‚ùå ${errorMsg}`);
                            reject(new Error(errorMsg));
                        }
                    };
                                        // Crear formulario para POST (m√°s confiable que GET con muchos par√°metros)
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = SCRIPT_URL;
                    form.style.display = 'none';
                    
                    // Agregar par√°metros como campos ocultos
                    const params = {
                        nombre: nombre,
                        telefono: telefono,
                        tipoTerapia: tipoTerapia,
                        edad: terapiaInfo.edad,
                        precio: terapiaInfo.precio.toString(),
                        duracion: terapiaInfo.duracion,
                        fecha: horarioSeleccionado.fecha,
                        hora: horarioSeleccionado.hora,
                        callback: callbackName
                    };
                    
                    Object.keys(params).forEach(key => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = params[key];
                        form.appendChild(input);
                    });
                    
                    document.body.appendChild(form);
                    
                    // Crear iframe para recibir la respuesta JSONP
                    const iframe = document.createElement('iframe');
                    iframe.name = 'jsonpFrame';
                    iframe.style.display = 'none';
                    iframe.onload = function() {
                        console.log('üì• Iframe cargado, respuesta recibida');
                        // La respuesta se maneja a trav√©s del callback
                    };
                    
                    document.body.appendChild(iframe);
                    form.target = 'jsonpFrame';
                    
                    console.log('üì§ Enviando reserva via POST...');
                    form.submit();
                    
                    // Tambi√©n intentamos con GET como fallback
                    setTimeout(() => {
                        const script = document.createElement('script');
                        const getParams = new URLSearchParams({
                            nombre: nombre,
                            telefono: telefono,
                            tipoTerapia: tipoTerapia,
                            edad: terapiaInfo.edad,
                            precio: terapiaInfo.precio.toString(),
                            duracion: terapiaInfo.duracion,
                            fecha: horarioSeleccionado.fecha,
                            hora: horarioSeleccionado.hora,
                            callback: callbackName,
                            _: Date.now()
                        });
                        
                        const urlCompleta = `${SCRIPT_URL}?${getParams.toString()}`;
                        console.log('üì§ Intentando tambi√©n con GET:', urlCompleta);
                        script.src = urlCompleta;
                        document.head.appendChild(script);
                    }, 1000);
                    
                    // Timeout de 30 segundos (m√°s tiempo para Apps Script)
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.warn('‚è∞ Timeout en reserva (30 segundos)');
                            delete window[callbackName];
                            elementos.submitBtn.disabled = false;
                            elementos.submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Reserva';
                            mostrarError('‚è∞ El servidor no respondi√≥ en 30 segundos. Verifica tu conexi√≥n o intenta m√°s tarde.');
                            reject(new Error('Timeout'));
                        }
                    }, 30000); // 30 segundos para Apps Script
                });
                
            } catch (error) {
                console.error('üí• Error en enviarReserva:', error);
                mostrarError(`‚ùå Error inesperado: ${error.message}`);
                elementos.submitBtn.disabled = false;
                elementos.submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Reserva';
            }
        }
        
        // ==================== CARGAR HORARIOS ====================
        
        async function cargarHorarios() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üîÑ Iniciando carga de horarios...');
                    
                    elementos.horariosList.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Cargando horarios exclusivos...</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Solo mostramos los horarios m√°s solicitados</p>
                        </div>
                    `;
                    
                    const callbackName = 'callback_' + Math.random().toString(36).substr(2, 9);
                    
                    window[callbackName] = function(response) {
                        console.log('üì® Respuesta recibida en callback:', response);
                        
                        try {
                            delete window[callbackName];
                        } catch (e) {
                            console.warn('‚ö†Ô∏è No se pudo eliminar callback:', e);
                        }
                        
                        if (response && response.success === true) {
                            console.log(`‚úÖ ${response.count} horarios recibidos`);
                            
                            horariosDisponibles = response.data || [];
                            elementos.lastUpdate.textContent = new Date().toLocaleTimeString('es-MX');
                            
                            mostrarDiasFiltro();
                            aplicarFiltros();
                            
                            if (horariosDisponibles.length > 0) {
                                const horasUnicas = extraerHorasUnicasEstaSemana(horariosDisponibles);
                                llenarSelectorHoras(horasUnicas);
                            }
                            
                            resolve(response);
                            
                        } else {
                            console.error('‚ùå Error en respuesta:', response);
                            mostrarError('‚ùå Error del servidor: ' + (response?.error || 'Desconocido'));
                            // Mostrar datos de ejemplo en caso de error
                            mostrarHorariosDeEjemplo();
                            resolve({ success: false, count: 0, data: [], error: response?.error });
                        }
                    };
                    
                    const script = document.createElement('script');
                    const urlConCallback = `${SCRIPT_URL}?callback=${callbackName}&nocache=${Date.now()}`;
                    script.src = urlConCallback;
                    
                    console.log('üì§ Solicitando horarios:', urlConCallback);
                    
                    script.onerror = function(err) {
                        console.error('‚ùå Error cargando script:', err);
                        
                        try {
                            delete window[callbackName];
                        } catch (e) {}
                        
                        // Mostrar datos de ejemplo en caso de error de red
                        mostrarHorariosDeEjemplo();
                        mostrarError('‚ö†Ô∏è No se pudo conectar al servidor. Mostrando datos de ejemplo.');
                        resolve({ success: false, count: 0, data: [], error: 'Network error' });
                    };
                    
                    document.head.appendChild(script);
                    
                    // Timeout de 15 segundos
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.warn('‚è∞ Timeout esperando respuesta (15 segundos)');
                            try {
                                delete window[callbackName];
                            } catch (e) {}
                            
                            // Mostrar datos de ejemplo si hay timeout
                            mostrarHorariosDeEjemplo();
                            mostrarError('‚ö†Ô∏è El servidor tard√≥ en responder. Mostrando datos de ejemplo.');
                            resolve({ success: false, count: 0, data: [], error: 'Timeout' });
                        }
                    }, 15000);
                    
                } catch (error) {
                    console.error('üí• Error en cargarHorarios:', error);
                    
                    // Mostrar datos de ejemplo en caso de error
                    mostrarHorariosDeEjemplo();
                    
                    elementos.horariosList.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">‚ö†Ô∏è</div>
                            <p style="font-size: 1.2rem; margin-bottom: 10px;">Error cargando horarios</p>
                            <p style="font-size: 0.9rem; color: #888;">${error.message}</p>
                            <p style="margin-top: 15px; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Mostrando datos de ejemplo.
                            </p>
                        </div>
                    `;
                    
                    elementos.contadorHorarios.textContent = '0';
                    
                    resolve({ success: false, count: 0, data: [], error: error.message });
                }
            });
        }
        
        // Funci√≥n para mostrar horarios de ejemplo (fallback)
        function mostrarHorariosDeEjemplo() {
            console.log('üìã Mostrando horarios de ejemplo');
            
            // Generar horarios de ejemplo para 14 d√≠as
            const hoy = new Date();
            const horariosEjemplo = [];
            
            // Generar para los pr√≥ximos 14 d√≠as
            for (let i = 0; i < 14; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                
                // Saltar domingos
                if (fecha.getDay() === 0) {
                    continue;
                }
                
                const fechaStr = fecha.toISOString().split('T')[0];
                const diaSemana = fecha.getDay();
                const esSabado = diaSemana === 6;
                
                if (esSabado) {
                    // S√°bados: 9am-2pm
                    for (let hora = 9; hora <= 14; hora++) {
                        horariosEjemplo.push({
                            fecha: fechaStr,
                            hora: `${hora.toString().padStart(2, '0')}:00`,
                            estado: 'libre',
                            paciente: ''
                        });
                    }
                } else {
                    // Lunes a Viernes
                    // Horarios de tarde alta demanda (4-6pm)
                    for (let hora = 16; hora <= 18; hora++) {
                        horariosEjemplo.push({
                            fecha: fechaStr,
                            hora: `${hora.toString().padStart(2, '0')}:00`,
                            estado: 'libre',
                            paciente: ''
                        });
                    }
                    
                    // Horarios de tarde media (3pm, 7pm)
                    [15, 19].forEach(hora => {
                        horariosEjemplo.push({
                            fecha: fechaStr,
                            hora: `${hora.toString().padStart(2, '0')}:00`,
                            estado: 'libre',
                            paciente: ''
                        });
                    });
                    
                    // Horarios de ma√±ana (11am-2pm)
                    for (let hora = 11; hora <= 14; hora++) {
                        horariosEjemplo.push({
                            fecha: fechaStr,
                            hora: `${hora.toString().padStart(2, '0')}:00`,
                            estado: 'libre',
                            paciente: ''
                        });
                    }
                }
            }
            
            horariosDisponibles = horariosEjemplo;
            elementos.contadorHorarios.textContent = horariosEjemplo.length;
            mostrarDiasFiltro();
            aplicarFiltros();
            
            mostrarMensaje('‚ö†Ô∏è Mostrando datos de ejemplo. La reserva funcionar√° normalmente.', 'error');
        }
        
        // ==================== FUNCIONES DE MENSAJES ====================
        
        function mostrarMensaje(mensaje, tipo) {
            elementos.statusMessage.textContent = mensaje;
            elementos.statusMessage.className = 'status-message ' + tipo;
            elementos.statusMessage.style.display = 'block';
            
            setTimeout(() => {
                elementos.statusMessage.style.display = 'none';
            }, 5000);
        }
        
        function mostrarError(mensaje) {
            mostrarMensaje(mensaje, 'error');
        }
        
        // ==================== INICIALIZACI√ìN ====================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOM cargado');
            console.log('üîß Sistema de reservas premium inicializando...');
            console.log('üì° Web App URL:', SCRIPT_URL);
            console.log('üìÖ Fecha actual:', new Date().toLocaleDateString('es-MX'));
            console.log('üìÖ D√≠a actual:', new Date().getDay(), '=', diasSemana[new Date().getDay()]);
            
            // Configurar tipos de terapia (select/dropdown)
            configurarTiposTerapia();
            
            // Configurar filtros
            elementos.filtroBtns.forEach(btn => {
                btn.addEventListener('click', () => cambiarFiltro(btn.dataset.tipo));
            });
            
            elementos.buscarHora.addEventListener('change', () => {
                horaFiltro = elementos.buscarHora.value;
                filtroActivo = 'hora-especifica';
                aplicarFiltros();
            });
            
            // Configurar formulario
            elementos.reservaForm.addEventListener('submit', enviarReserva);
            
            // Configurar bot√≥n de refresh
            elementos.refreshBtn.addEventListener('click', () => {
                elementos.refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
                elementos.refreshBtn.disabled = true;
                
                cargarHorarios().finally(() => {
                    setTimeout(() => {
                        elementos.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar Disponibilidad';
                        elementos.refreshBtn.disabled = false;
                        mostrarMensaje('‚úÖ Horarios actualizados exitosamente.', 'success');
                    }, 1000);
                });
            });
            
            // Configurar input de tel√©fono para solo n√∫meros
            elementos.telefonoInput.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
            });
            
            // Cargar horarios iniciales
            cargarHorarios().then(response => {
                console.log('‚úÖ Sistema cargado correctamente');
                console.log(`üìä ${response.count} horarios cargados`);
                
                if (response.count === 0 && !response.error) {
                    mostrarError('‚ö†Ô∏è No hay horarios disponibles en este momento.');
                }
            }).catch(error => {
                console.error('‚ùå Error cargando horarios:', error);
                mostrarError('‚ö†Ô∏è No se pudieron cargar los horarios en tiempo real. Mostrando datos de ejemplo.');
            });
        });
        
        // Exponer funciones globales necesarias
        window.seleccionarHorarioPorId = seleccionarHorarioPorId;
        window.filtrarPorDia = filtrarPorDia;
        window.cambiarFiltro = cambiarFiltro;
        window.aplicarFiltros = aplicarFiltros;
        window.enviarReserva = enviarReserva;
        window.cargarHorarios = cargarHorarios;
    </script>
</body>
</html>
